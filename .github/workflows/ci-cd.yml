name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20'
  RESOURCE_GROUP: 'EVEAbacus'
  VM_NAME: ${{ secrets.VM_NAME }}

jobs:
  # Build and test backend
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Cache .NET dependencies
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      
      - name: Restore dependencies
        run: dotnet restore ./EVEAbacus.WebUI/EVEAbacus.WebUI.csproj
      
      - name: Build backend
        run: dotnet build --no-restore --configuration Release ./EVEAbacus.WebUI/EVEAbacus.WebUI.csproj
      
      - name: Test backend
        run: dotnet test --no-build --verbosity normal ./EVEAbacus.WebUI/EVEAbacus.WebUI.csproj
      
      - name: Publish backend
        run: dotnet publish --configuration Release --output ./publish-backend ./EVEAbacus.WebUI/EVEAbacus.WebUI.csproj
      
      - name: Prepare backend artifacts
        run: |
          # Copy systemd service file to backend artifacts
          cp ./eveabacus-backend.service ./publish-backend/
          echo "üìÅ Backend artifacts prepared:"
          ls -la ./publish-backend/
      
      - name: Upload backend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-artifacts
          path: ./publish-backend
          retention-days: 1

  # Deploy backend to production
  deploy-backend:
    needs: [build-backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download backend artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-artifacts
          path: ./backend-artifacts
      
      - name: Debug downloaded artifacts
        run: |
          echo "üîç Checking downloaded artifacts..."
          echo "Backend artifacts:"
          ls -la ./backend-artifacts/ || echo "Backend artifacts not found"
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: List available VMs
        run: |
          echo "Available VMs in resource group ${{ env.RESOURCE_GROUP }}:"
          az vm list --resource-group ${{ env.RESOURCE_GROUP }} --query "[].{Name:name, Status:powerState}" -o table
      
      - name: Deploy backend to Azure VM
        run: |
          # Stop backend service
          echo "Stopping backend service..."
          az vm run-command invoke \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.VM_NAME }} \
            --command-id RunShellScript \
            --scripts "
              sudo systemctl stop eveabacus-backend 2>/dev/null || true
            "
          
          # Create storage account for large files
          echo "Setting up storage for backend deployment..."
          STORAGE_ACCOUNT_NAME="evebackend$(date +%s)"
          az storage account create \
            --name $STORAGE_ACCOUNT_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --location eastus \
            --sku Standard_LRS \
            --kind StorageV2
          
          # Get storage key
          STORAGE_KEY=$(az storage account keys list \
            --account-name $STORAGE_ACCOUNT_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query '[0].value' -o tsv)
          
          # Create container
          az storage container create \
            --name deployments \
            --account-name $STORAGE_ACCOUNT_NAME \
            --account-key $STORAGE_KEY
          
          # Upload backend artifacts
          echo "Uploading backend artifacts..."
          tar -czf backend-artifacts.tar.gz -C ./backend-artifacts .
          az storage blob upload \
            --account-name $STORAGE_ACCOUNT_NAME \
            --account-key $STORAGE_KEY \
            --container-name deployments \
            --name backend-artifacts.tar.gz \
            --file backend-artifacts.tar.gz
          
          # Deploy backend from storage
          echo "Deploying backend from storage..."
          # Generate SAS token for backend artifacts
          BACKEND_SAS=$(az storage blob generate-sas \
            --account-name $STORAGE_ACCOUNT_NAME \
            --account-key $STORAGE_KEY \
            --container-name deployments \
            --name backend-artifacts.tar.gz \
            --permissions r \
            --expiry $(date -u -d "1 hour" '+%Y-%m-%dT%H:%M:%SZ') \
            --full-uri \
            --output tsv)
          
          az vm run-command invoke \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.VM_NAME }} \
            --command-id RunShellScript \
            --scripts "
              echo 'üîç Starting backend deployment...'
              sudo mkdir -p /var/www/eveabacus
              sudo rm -rf /var/www/eveabacus/*
              cd /tmp
              echo 'üì• Downloading backend artifacts...'
              curl -L -o backend-artifacts.tar.gz \"$BACKEND_SAS\"
              echo 'üì¶ Extracting backend artifacts...'
              echo 'üìÅ Checking tar file contents before extraction:'
              tar -tzf backend-artifacts.tar.gz | head -20
              echo 'üì¶ Extracting with verbose output:'
              tar -xzf backend-artifacts.tar.gz -C /var/www/eveabacus/
              echo 'üìÅ Extracted backend contents:'
              ls -la /var/www/eveabacus/
              echo 'üìÅ Checking for .NET DLL files:'
              find /var/www/eveabacus -name "*.dll" | head -5 || echo "No DLL files found"
              echo 'üìÅ Checking for EVEAbacus.WebUI.dll specifically:'
              ls -la /var/www/eveabacus/EVEAbacus.WebUI.dll || echo 'EVEAbacus.WebUI.dll not found'
              echo 'üìÅ Checking for systemd service file:'
              ls -la /var/www/eveabacus/eveabacus-backend.service || echo 'eveabacus-backend.service not found'
              
              # Copy systemd service file
              echo 'üìÅ Copying systemd service file...'
              sudo cp /var/www/eveabacus/eveabacus-backend.service /etc/systemd/system/eveabacus-backend.service
              sudo chmod 644 /etc/systemd/system/eveabacus-backend.service
              
              # Add the connection string environment variable from GitHub secrets
              echo 'üîß Adding database connection string from secrets...'
              sudo sed -i '/Environment=ASPNETCORE_URLS/a Environment=ConnectionStrings__EVEAbacus=${{ secrets.CONNECTIONSTRINGS__BACKEND }}' /etc/systemd/system/eveabacus-backend.service
              
              # Add the Redis password environment variable from GitHub secrets
              echo 'üîß Adding Redis password from secrets...'
              sudo sed -i '/Environment=ConnectionStrings__EVEAbacus/a Environment=REDIS__PASSWORD=${{ secrets.REDIS__PASSWORD }}' /etc/systemd/system/eveabacus-backend.service
              
              # Debug: Show the final service file configuration
              echo 'üìã Final service configuration:'
              sudo cat /etc/systemd/system/eveabacus-backend.service
              
              echo 'üîß Setting permissions...'
              sudo chown -R eveabacus:eveabacus /var/www/eveabacus
              sudo chmod -R 755 /var/www/eveabacus
              echo 'üìÅ Final backend deployment contents:'
              ls -la /var/www/eveabacus/
              echo 'üìÅ Checking if EVEAbacus.WebUI.dll exists:'
              ls -la /var/www/eveabacus/EVEAbacus.WebUI.dll || echo 'EVEAbacus.WebUI.dll not found after copy'
              echo 'üìÅ Checking if dotnet is available:'
              which dotnet || echo 'dotnet not found in PATH'
              dotnet --version || echo 'dotnet version check failed'
              sudo systemctl daemon-reload
              rm -f backend-artifacts.tar.gz
              echo '‚úÖ Backend deployment complete'
            "
          
          # Clean up storage account
          echo "Cleaning up storage account..."
          az storage account delete \
            --name $STORAGE_ACCOUNT_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --yes
          
          # Start backend service
          echo "Starting backend service..."
          az vm run-command invoke \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.VM_NAME }} \
            --command-id RunShellScript \
            --scripts "
              echo 'üîß Starting backend service...'
              # Start backend service if it exists
              if systemctl list-unit-files | grep -q eveabacus-backend.service; then
                echo 'üöÄ Starting eveabacus-backend service...'
                sudo systemctl start eveabacus-backend
                echo '‚è≥ Waiting for backend to be ready...'
                sleep 10
                echo '‚úÖ Backend service started'
              else
                echo '‚ö†Ô∏è  eveabacus-backend service not found'
              fi
            "
          
          # Wait for backend to be ready
          echo "Waiting for backend to be ready..."
          az vm run-command invoke \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.VM_NAME }} \
            --command-id RunShellScript \
            --scripts "
              echo 'üîç Checking if backend is ready...'
              echo 'üìã Checking backend service status:'
              sudo systemctl status eveabacus-backend || echo 'Backend service not found or failed'
              echo 'üìã Checking backend service logs:'
              sudo journalctl -u eveabacus-backend -n 10 --no-pager || echo 'No backend service logs found'
              echo 'üìã Checking if port 5000 is listening:'
              sudo netstat -tlnp | grep :5000 || echo 'Port 5000 not listening'
              echo 'üìã Checking backend process:'
              ps aux | grep eveabacus-backend || echo 'No eveabacus-backend process found'
              echo 'üìã Checking Redis connection (port 6379):'
              sudo netstat -tlnp | grep :6379 || echo 'Redis not listening on port 6379'
              echo 'üìã Testing Redis connection:'
              redis-cli -h localhost -p 6379 ping 2>/dev/null || echo 'Redis ping failed'
              
              for i in {1..30}; do
                echo 'üîç Attempt $i: Testing backend health endpoint...'
                if curl -f http://localhost:5000/health 2>/dev/null; then
                  echo '‚úÖ Backend is ready!'
                  exit 0
                else
                  echo '‚ùå Health check failed'
                  echo 'üìã Trying to get more info:'
                  curl -v http://localhost:5000/health 2>&1 | head -10 || echo 'Curl failed completely'
                fi
                echo '‚è≥ Waiting for backend to be ready... (attempt $i/30)'
                sleep 5
              done
              echo '‚ö†Ô∏è  Backend may not be fully ready, but continuing...'
              echo 'üìã Final backend service status:'
              sudo systemctl status eveabacus-backend || echo 'Backend service not found'
            "
          
          echo "‚úÖ Backend deployment completed successfully"
          echo "üìã Summary: Backend should now be running and ready for frontend build"

  # Build frontend (after backend is deployed and running)
  build-frontend:
    needs: [deploy-backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
      
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Setup Next.js cache
        uses: actions/cache@v4
        with:
          path: |
            ./eve-abacus-webui/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/*.ts', '**/*.tsx', '**/*.js', '**/*.jsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-
            ${{ runner.os }}-nextjs-
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: ./eve-abacus-webui
      
      - name: Build frontend
        run: pnpm build
        working-directory: ./eve-abacus-webui
      
      - name: Debug build output
        run: |
          echo "üîç Debugging frontend build output..."
          echo "üìÅ Current directory: $(pwd)"
          echo "üìÅ eve-abacus-webui directory contents:"
          ls -la ./eve-abacus-webui/
          echo ""
          echo "üìÅ .next directory exists:"
          if [ -d "./eve-abacus-webui/.next" ]; then
            echo "‚úÖ .next directory found"
            ls -la ./eve-abacus-webui/.next/
            echo ""
            echo "üìÅ BUILD_ID file:"
            ls -la ./eve-abacus-webui/.next/BUILD_ID || echo "BUILD_ID not found"
            echo ""
            echo "üìÅ Server directory:"
            ls -la ./eve-abacus-webui/.next/server/ || echo "server directory not found"
            echo ""
            echo "üìÅ Static directory:"
            ls -la ./eve-abacus-webui/.next/static/ || echo "static directory not found"
            echo ""
            echo "üìÅ Standalone directory:"
            ls -la ./eve-abacus-webui/.next/standalone/ || echo "standalone directory not found"
            echo ""
            echo "üìÅ Checking standalone .next directory:"
            ls -la ./eve-abacus-webui/.next/standalone/.next/ || echo "standalone .next directory not found"
            echo ""
            echo "üìÅ Checking standalone BUILD_ID:"
            ls -la ./eve-abacus-webui/.next/standalone/.next/BUILD_ID || echo "standalone BUILD_ID not found"
            echo ""
            echo "üìÅ Checking standalone static directory:"
            ls -la ./eve-abacus-webui/.next/standalone/.next/static/ || echo "standalone static directory not found"
            echo ""
            echo "üìÅ Checking standalone node_modules:"
            ls -la ./eve-abacus-webui/.next/standalone/node_modules/ | head -5 || echo "standalone node_modules not found"
            echo ""
            echo "üìÅ Checking for styled-jsx in standalone:"
            ls -la ./eve-abacus-webui/.next/standalone/node_modules/styled-jsx/ || echo "styled-jsx not found"
          else
            echo "‚ùå .next directory not found - build may have failed"
            echo "üìÅ Checking for any build artifacts:"
            find ./eve-abacus-webui -name "*.js" -o -name "*.json" | head -10
          fi
          echo ""
          echo "üìÅ package.json exists:"
          ls -la ./eve-abacus-webui/package.json || echo "package.json not found"
          echo ""
          echo "üìÅ public directory exists:"
          ls -la ./eve-abacus-webui/public/ || echo "public directory not found"
        working-directory: ./
      
      - name: Check if build artifacts exist
        run: |
          if [ ! -d "./eve-abacus-webui/.next" ]; then
            echo "‚ùå Frontend build failed - .next directory not found"
            exit 1
          fi
          echo "‚úÖ Frontend build artifacts found"
          ls -la ./eve-abacus-webui/.next/
          
          # Check for BUILD_ID file (required for production builds)
          echo "üìÅ Checking for BUILD_ID file:"
          if [ -f "./eve-abacus-webui/.next/BUILD_ID" ]; then
            echo "‚úÖ BUILD_ID found: $(cat ./eve-abacus-webui/.next/BUILD_ID)"
          else
            echo "‚ùå BUILD_ID not found - this is required for production builds"
          fi
          
          # Check for server directory
          echo "üìÅ Checking for server directory:"
          if [ -d "./eve-abacus-webui/.next/server" ]; then
            echo "‚úÖ Server directory found"
            ls -la ./eve-abacus-webui/.next/server/
          else
            echo "‚ùå Server directory not found"
          fi
          
          # Check for static directory
          echo "üìÅ Checking for static directory:"
          if [ -d "./eve-abacus-webui/.next/static" ]; then
            echo "‚úÖ Static directory found"
            ls -la ./eve-abacus-webui/.next/static/
          else
            echo "‚ùå Static directory not found"
          fi
          
          # Check for build output
          echo "üìÅ Checking build output structure:"
          echo "üìÅ Available files in .next:"
          find ./eve-abacus-webui/.next -type f -name "*.js" | head -10
          echo "üìÅ All directories in .next:"
          ls -la ./eve-abacus-webui/.next/
          echo ""
          echo "üìÅ Checking for standalone output:"
          if [ -d "./eve-abacus-webui/.next/standalone" ]; then
            echo "‚úÖ Standalone output found"
            ls -la ./eve-abacus-webui/.next/standalone/
            echo "üìÅ Checking for server.js in standalone:"
            ls -la ./eve-abacus-webui/.next/standalone/server.js || echo "server.js not found"
            echo "üìÅ Checking for BUILD_ID in standalone .next:"
            ls -la ./eve-abacus-webui/.next/standalone/.next/BUILD_ID || echo "BUILD_ID not found"
          else
            echo "‚ùå Standalone output not found"
          fi
        working-directory: ./
      
      - name: Debug frontend artifacts
        run: |
          echo "üìÅ Frontend artifacts to be uploaded:"
          echo "Contents of standalone directory:"
          find ./eve-abacus-webui/.next/standalone -type f -name "*.js" | head -10
          echo ""
          echo "Contents of public directory:"
          ls -la ./eve-abacus-webui/public/
          echo ""
          echo "üìÅ Checking standalone build structure:"
          echo "üìÅ Available files in standalone:"
          ls -la ./eve-abacus-webui/.next/standalone/
          echo ""
          echo "üìÅ Checking if server.js exists:"
          ls -la ./eve-abacus-webui/.next/standalone/server.js || echo "server.js not found"
          echo ""
          echo "üìÅ Checking if BUILD_ID exists in standalone .next:"
          ls -la ./eve-abacus-webui/.next/standalone/.next/BUILD_ID || echo "BUILD_ID not found"
        working-directory: ./
      
      - name: Prepare frontend artifacts
        run: |
          echo "üîç Preparing frontend artifacts..."
          echo "üìÅ Current directory: $(pwd)"
          echo "üìÅ eve-abacus-webui directory contents:"
          ls -la ./eve-abacus-webui/
          
          mkdir -p ./frontend-build
          echo "üìÅ Created frontend-build directory"
          
          # Copy standalone build for production deployment
          echo "üìÅ Copying standalone build..."
          if [ -d "./eve-abacus-webui/.next/standalone" ]; then
            echo "üìÅ Original standalone directory contents:"
            ls -la ./eve-abacus-webui/.next/standalone/
            echo "üìÅ Checking for .next in original standalone:"
            ls -la ./eve-abacus-webui/.next/standalone/.next/ || echo ".next directory not found in original standalone"
            echo "üìÅ Checking for BUILD_ID in original standalone:"
            ls -la ./eve-abacus-webui/.next/standalone/.next/BUILD_ID || echo "BUILD_ID not found in original standalone"
            echo "üìÅ Checking for static directory in original standalone:"
            ls -la ./eve-abacus-webui/.next/standalone/.next/static/ || echo "static directory not found in original standalone"
            
            # Copy the standalone directory as-is (it already contains everything needed)
            cp -r ./eve-abacus-webui/.next/standalone ./frontend-build/
            echo "‚úÖ standalone directory copied"
            
            # Always ensure the .next directory exists in the standalone build
            echo "üîß Ensuring .next directory exists in standalone build..."
            mkdir -p ./frontend-build/standalone/.next
            
            # Copy BUILD_ID
            if [ -f "./eve-abacus-webui/.next/BUILD_ID" ]; then
              cp ./eve-abacus-webui/.next/BUILD_ID ./frontend-build/standalone/.next/
              echo "‚úÖ BUILD_ID copied"
            fi
            
            # Copy static directory
            if [ -d "./eve-abacus-webui/.next/static" ]; then
              cp -r ./eve-abacus-webui/.next/static ./frontend-build/standalone/.next/
              echo "‚úÖ static directory copied"
            fi
            
            # Copy server directory
            if [ -d "./eve-abacus-webui/.next/server" ]; then
              cp -r ./eve-abacus-webui/.next/server ./frontend-build/standalone/.next/
              echo "‚úÖ server directory copied"
            fi
            
            # Copy other important files
            for file in "app-build-manifest.json" "build-manifest.json" "prerender-manifest.json" "react-loadable-manifest.json" "required-server-files.json" "routes-manifest.json"; do
              if [ -f "./eve-abacus-webui/.next/$file" ]; then
                cp "./eve-abacus-webui/.next/$file" "./frontend-build/standalone/.next/"
                echo "‚úÖ $file copied"
              fi
            done
            
            # Ensure styled-jsx is available in standalone build
            echo "üîß Ensuring styled-jsx is available in standalone build..."
            if [ ! -d "./frontend-build/standalone/node_modules/styled-jsx" ]; then
              echo "‚ö†Ô∏è styled-jsx not found in standalone build, copying from main node_modules..."
              if [ -d "./eve-abacus-webui/node_modules/styled-jsx" ]; then
                mkdir -p ./frontend-build/standalone/node_modules/
                cp -r ./eve-abacus-webui/node_modules/styled-jsx ./frontend-build/standalone/node_modules/
                echo "‚úÖ styled-jsx copied to standalone build"
              else
                echo "‚ùå styled-jsx not found in main node_modules either"
              fi
            else
              echo "‚úÖ styled-jsx already exists in standalone build"
            fi
            
            # Ensure @swc/helpers is available in standalone build
            echo "üîß Ensuring @swc/helpers is available in standalone build..."
            if [ ! -d "./frontend-build/standalone/node_modules/@swc/helpers" ]; then
              echo "‚ö†Ô∏è @swc/helpers not found in standalone build, copying from main node_modules..."
              if [ -d "./eve-abacus-webui/node_modules/@swc/helpers" ]; then
                mkdir -p ./frontend-build/standalone/node_modules/@swc/
                cp -r ./eve-abacus-webui/node_modules/@swc/helpers ./frontend-build/standalone/node_modules/@swc/
                echo "‚úÖ @swc/helpers copied to standalone build"
              else
                echo "‚ùå @swc/helpers not found in main node_modules either"
              fi
            else
              echo "‚úÖ @swc/helpers already exists in standalone build"
            fi
          else
            echo "‚ùå standalone directory not found - cannot copy"
          fi
          
          echo "üìÅ Verifying standalone directory was copied:"
          ls -la ./frontend-build/standalone/ || echo "standalone directory not found in frontend-build"
          echo "üìÅ Checking server.js in copied directory:"
          ls -la ./frontend-build/standalone/server.js || echo "server.js not found in copied directory"
          echo "üìÅ Checking for .next directory in standalone:"
          ls -la ./frontend-build/standalone/.next/ || echo ".next directory not found in standalone"
          echo "üìÅ Checking BUILD_ID in standalone .next:"
          ls -la ./frontend-build/standalone/.next/BUILD_ID || echo "BUILD_ID not found in standalone .next"
          echo "üìÅ Checking static directory in standalone .next:"
          ls -la ./frontend-build/standalone/.next/static/ || echo "static directory not found in standalone .next"
          echo "üìÅ Checking node_modules in standalone:"
          ls -la ./frontend-build/standalone/node_modules/ | head -5 || echo "node_modules not found in standalone"
          echo "üìÅ Checking for styled-jsx specifically:"
          ls -la ./frontend-build/standalone/node_modules/styled-jsx/ || echo "styled-jsx not found"
          echo "üìÅ Full standalone directory structure:"
          find ./frontend-build/standalone -type f -name "*.js" | head -10
          echo "üìÅ Checking standalone node_modules contents:"
          ls -la ./frontend-build/standalone/node_modules/ | head -10 || echo "node_modules not found"
          echo "üìÅ Checking for styled-jsx in standalone node_modules:"
          ls -la ./frontend-build/standalone/node_modules/styled-jsx/ || echo "styled-jsx not found in standalone"
          echo "üìÅ Checking main node_modules for styled-jsx:"
          ls -la ./eve-abacus-webui/node_modules/styled-jsx/ || echo "styled-jsx not found in main"
          echo "üìÅ Checking for @swc/helpers in standalone node_modules:"
          ls -la ./frontend-build/standalone/node_modules/@swc/helpers/ || echo "@swc/helpers not found in standalone"
          echo "üìÅ Checking main node_modules for @swc/helpers:"
          ls -la ./eve-abacus-webui/node_modules/@swc/helpers/ || echo "@swc/helpers not found in main"
          
          # Copy public directory for static assets
          echo "üìÅ Copying public directory..."
          if [ -d "./eve-abacus-webui/public" ]; then
            cp -r ./eve-abacus-webui/public ./frontend-build/
            echo "‚úÖ public directory copied"
          else
            echo "‚ùå public directory not found - cannot copy"
          fi
          
          # Copy systemd service files
          echo "üìÅ Copying systemd service file..."
          if [ -f "./eveabacus-frontend.service" ]; then
            cp ./eveabacus-frontend.service ./frontend-build/
            echo "‚úÖ eveabacus-frontend.service copied"
          else
            echo "‚ùå eveabacus-frontend.service not found - cannot copy"
          fi
          
          echo "üìÅ Final frontend artifacts:"
          ls -la ./frontend-build/
          echo "üìÅ standalone directory contents:"
          ls -la ./frontend-build/standalone/ || echo "standalone directory not found in frontend-build"
        working-directory: ./
      
      - name: Upload frontend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-artifacts
          path: ./frontend-build
          retention-days: 1

  # Deploy frontend to production
  deploy-frontend:
    needs: [build-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-artifacts
          path: ./frontend-artifacts
      
      - name: Debug downloaded artifacts
        run: |
          echo "üîç Checking downloaded artifacts..."
          echo "Frontend artifacts:"
          ls -la ./frontend-artifacts/ || echo "Frontend artifacts not found"
          echo ""
          echo "Frontend standalone directory:"
          ls -la ./frontend-artifacts/standalone/ || echo "standalone directory not found"
          echo ""
          echo "Frontend public directory:"
          ls -la ./frontend-artifacts/public/ || echo "public directory not found"
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy frontend to Azure VM
        run: |
          # Stop frontend service
          echo "Stopping frontend service..."
          az vm run-command invoke \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.VM_NAME }} \
            --command-id RunShellScript \
            --scripts "
              sudo systemctl stop eveabacus-frontend 2>/dev/null || true
            "
          
          # Create storage account for large files
          echo "Setting up storage for frontend deployment..."
          STORAGE_ACCOUNT_NAME="evefrontend$(date +%s)"
          az storage account create \
            --name $STORAGE_ACCOUNT_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --location eastus \
            --sku Standard_LRS \
            --kind StorageV2
          
          # Get storage key
          STORAGE_KEY=$(az storage account keys list \
            --account-name $STORAGE_ACCOUNT_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query '[0].value' -o tsv)
          
          # Create container
          az storage container create \
            --name deployments \
            --account-name $STORAGE_ACCOUNT_NAME \
            --account-key $STORAGE_KEY
          
          # Upload frontend artifacts
          echo "Uploading frontend artifacts..."
          tar -czf frontend-artifacts.tar.gz -C ./frontend-artifacts .
          az storage blob upload \
            --account-name $STORAGE_ACCOUNT_NAME \
            --account-key $STORAGE_KEY \
            --container-name deployments \
            --name frontend-artifacts.tar.gz \
            --file frontend-artifacts.tar.gz
          
          # Deploy frontend from storage
          echo "Deploying frontend from storage..."
          # Generate SAS token for frontend artifacts
          FRONTEND_SAS=$(az storage blob generate-sas \
            --account-name $STORAGE_ACCOUNT_NAME \
            --account-key $STORAGE_KEY \
            --container-name deployments \
            --name frontend-artifacts.tar.gz \
            --permissions r \
            --expiry $(date -u -d "1 hour" '+%Y-%m-%dT%H:%M:%SZ') \
            --full-uri \
            --output tsv)
          
          az vm run-command invoke \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.VM_NAME }} \
            --command-id RunShellScript \
            --scripts "
              echo 'üîç Starting frontend deployment...'
              sudo mkdir -p /var/www/eveabacus/frontend
              sudo rm -rf /var/www/eveabacus/frontend/*
              cd /tmp
              echo 'üì• Downloading frontend artifacts...'
              curl -L -o frontend-artifacts.tar.gz \"$FRONTEND_SAS\"
              echo 'üì¶ Extracting frontend artifacts...'
              echo 'üìÅ Checking tar file contents before extraction:'
              tar -tzf frontend-artifacts.tar.gz | head -20
              echo 'üì¶ Extracting with verbose output:'
              tar -xzf frontend-artifacts.tar.gz
              echo 'üìÅ standalone directory contents:'
              ls -la /tmp/standalone/ || echo 'standalone directory not found'
              echo 'üìÅ Checking for server.js in standalone:'
              ls -la /tmp/standalone/server.js || echo 'server.js not found'
              echo 'üìÅ Checking for .next directory in standalone:'
              ls -la /tmp/standalone/.next/ || echo '.next directory not found'
              echo 'üìÅ Checking for BUILD_ID in standalone .next:'
              ls -la /tmp/standalone/.next/BUILD_ID || echo 'BUILD_ID not found in standalone .next'
              echo 'üìÅ Checking for node_modules in standalone:'
              ls -la /tmp/standalone/node_modules/ | head -5 || echo 'node_modules not found'
              echo 'üìÅ Checking for styled-jsx in standalone:'
              ls -la /tmp/standalone/node_modules/styled-jsx/ || echo 'styled-jsx not found'
              echo 'üìÅ public directory contents:'
              ls -la /tmp/public/ || echo 'public directory not found'
              echo 'üìÅ Checking for systemd service file:'
              ls -la /tmp/eveabacus-frontend.service || echo 'eveabacus-frontend.service not found'
              
              # Copy standalone build files
              echo 'üìÅ Copying standalone build files...'
              sudo cp -r /tmp/standalone /var/www/eveabacus/frontend/ 2>/dev/null || echo 'Failed to copy standalone directory'
              sudo cp -r /tmp/public /var/www/eveabacus/frontend/ 2>/dev/null || echo 'Failed to copy public directory'
              sudo cp /tmp/eveabacus-frontend.service /var/www/eveabacus/frontend/ 2>/dev/null || echo 'Failed to copy service file'
              
              echo 'üìÅ Frontend files copied:'
              ls -la /var/www/eveabacus/frontend/
              
              # Debug: Check standalone directory structure
              echo 'üìÅ Debugging standalone directory structure:'
              ls -la /var/www/eveabacus/frontend/standalone/ || echo 'standalone directory not found after copy'
              echo 'üìÅ Checking for server.js:'
              ls -la /var/www/eveabacus/frontend/standalone/server.js || echo 'server.js not found'
              echo 'üìÅ Checking for BUILD_ID file:'
              ls -la /var/www/eveabacus/frontend/standalone/.next/BUILD_ID || echo 'BUILD_ID not found'
              echo 'üìÅ Checking for .next directory:'
              ls -la /var/www/eveabacus/frontend/standalone/.next/ || echo '.next directory not found'
              echo 'üìÅ Checking standalone node_modules:'
              ls -la /var/www/eveabacus/frontend/standalone/node_modules/ | head -5 || echo 'node_modules not found'
              echo 'üìÅ Checking for styled-jsx:'
              ls -la /var/www/eveabacus/frontend/standalone/node_modules/styled-jsx/ || echo 'styled-jsx not found'
              
              echo 'üîß Setting permissions...'
              sudo chown -R www-data:www-data /var/www/eveabacus/frontend
              sudo chmod -R 755 /var/www/eveabacus/frontend
              echo 'üìÅ Final frontend deployment contents:'
              ls -la /var/www/eveabacus/frontend/
              echo 'üìÅ Checking if standalone directory exists:'
              ls -la /var/www/eveabacus/frontend/standalone/ || echo 'standalone directory not found after copy'
              echo 'üìÅ Checking if server.js exists:'
              ls -la /var/www/eveabacus/frontend/standalone/server.js || echo 'server.js not found after copy'
              echo 'üìÅ Checking if BUILD_ID exists:'
              ls -la /var/www/eveabacus/frontend/standalone/.next/BUILD_ID || echo 'BUILD_ID not found after copy'
              echo 'üìÅ Checking if styled-jsx exists:'
              ls -la /var/www/eveabacus/frontend/standalone/node_modules/styled-jsx/ || echo 'styled-jsx not found after copy'
              echo 'üìÅ Checking if node is available:'
              which node || echo 'node not found in PATH'
              node --version || echo 'node version check failed'
              rm -f frontend-artifacts.tar.gz
              echo '‚úÖ Frontend deployment complete'
            "
          
          # Clean up storage account
          echo "Cleaning up storage account..."
          az storage account delete \
            --name $STORAGE_ACCOUNT_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --yes
          
          # Start frontend service and reload nginx
          echo "Starting frontend service and reloading nginx..."
          az vm run-command invoke \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.VM_NAME }} \
            --command-id RunShellScript \
            --scripts "
              echo 'üîß Starting frontend service and reloading nginx...'
              
              # Update the service configuration
              echo 'üîß Updating frontend service configuration...'
              sudo systemctl stop eveabacus-frontend 2>/dev/null || true
              sudo rm -f /etc/systemd/system/eveabacus-frontend.service
              
              # Copy the service file from the repository
              echo 'üìÅ Copying systemd service file...'
              if [ -f '/var/www/eveabacus/frontend/eveabacus-frontend.service' ]; then
                sudo cp /var/www/eveabacus/frontend/eveabacus-frontend.service /etc/systemd/system/eveabacus-frontend.service
                sudo chmod 644 /etc/systemd/system/eveabacus-frontend.service
                echo '‚úÖ Service file copied successfully'
              else
                echo '‚ö†Ô∏è  Service file not found in frontend directory, trying repository root'
                # Try to copy from the repository root if not in frontend directory
                if [ -f '/var/www/eveabacus/eveabacus-frontend.service' ]; then
                  sudo cp /var/www/eveabacus/eveabacus-frontend.service /etc/systemd/system/eveabacus-frontend.service
                  sudo chmod 644 /etc/systemd/system/eveabacus-frontend.service
                  echo '‚úÖ Service file copied from repository root'
                else
                  echo '‚ùå Service file not found anywhere - service may not start properly'
                fi
              fi
              
              # Reload systemd to pick up the new configuration
              sudo systemctl daemon-reload
              
              # Start frontend service if it exists
              if systemctl list-unit-files | grep -q eveabacus-frontend.service; then
                echo 'üöÄ Starting eveabacus-frontend service...'
                sudo systemctl start eveabacus-frontend
                echo '‚è≥ Waiting for frontend service to start...'
                sleep 5
                if systemctl is-active --quiet eveabacus-frontend; then
                  echo '‚úÖ Frontend service started successfully'
                else
                  echo '‚ö†Ô∏è  Frontend service failed to start'
                  echo 'üìã Service status:'
                  sudo systemctl status eveabacus-frontend
                  echo 'üìã Recent logs:'
                  sudo journalctl -u eveabacus-frontend -n 20 --no-pager
                  echo 'üìã Checking if files exist:'
                  ls -la /var/www/eveabacus/frontend/ || echo 'Frontend directory not found'
                  ls -la /var/www/eveabacus/frontend/standalone/ || echo 'standalone directory not found'
                  ls -la /var/www/eveabacus/frontend/standalone/server.js || echo 'server.js not found'
                fi
              else
                echo '‚ö†Ô∏è  eveabacus-frontend service not found'
              fi
              
              # Reload nginx if it exists
              if systemctl list-unit-files | grep -q nginx.service; then
                echo 'üîÑ Reloading nginx...'
                sudo systemctl reload nginx
              else
                echo '‚ö†Ô∏è  nginx service not found'
              fi
              
              echo '‚úÖ Frontend deployment and service startup complete'
            " 